<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAG Outreach Builder</title>
  <style>
    :root {
      --bg: #f4f6f8;
      --panel: #ffffff;
      --accent: #0f766e;
      --accent-2: #f59e0b;
      --text: #0f172a;
      --muted: #475569;
      --border: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: "Avenir Next", "Segoe UI Variable", "SF Pro Display", "Helvetica Neue", sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(15, 118, 110, 0.12), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(245, 158, 11, 0.15), transparent 20%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 40px 24px 72px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 28px;
    }
    header h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.5px;
    }
    header p {
      margin: 6px 0 0;
      color: var(--muted);
      max-width: 640px;
      line-height: 1.5;
    }
    .tag {
      padding: 8px 14px;
      border-radius: 999px;
      background: var(--panel);
      border: 1px solid var(--border);
      font-size: 13px;
      color: var(--muted);
    }
    .grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 30px rgba(15, 23, 42, 0.08);
    }
    .panel h2 {
      margin: 0 0 14px;
      font-size: 19px;
      letter-spacing: -0.2px;
    }
    .section { margin-bottom: 16px; }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text);
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fdfefe;
      font-size: 14px;
      color: var(--text);
      transition: border 0.15s ease, box-shadow 0.15s ease;
    }
    input[type="text"]:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.12);
      outline: none;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.5;
    }
    .inline {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .hint {
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
      line-height: 1.4;
    }
    .upload {
      border: 1px dashed var(--border);
      background: #f8fafc;
      padding: 12px 14px;
      border-radius: 12px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--accent), #0d4d46);
      color: #ffffff;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      font-size: 14px;
      letter-spacing: 0.2px;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(15, 118, 110, 0.25); }
    .btn:active { transform: translateY(0); box-shadow: none; }
    .btn.secondary { background: #0f172a; }
    .output {
      background: #0f172a;
      color: #e2e8f0;
      border-radius: 14px;
      padding: 16px;
      min-height: 220px;
      white-space: pre-wrap;
      line-height: 1.6;
      border: 1px solid #1e293b;
    }
    .output header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 0 0 12px;
      padding: 0 0 8px;
      border-bottom: 1px solid #1f2937;
    }
    .output header h3 {
      margin: 0;
      font-size: 15px;
      letter-spacing: 0.2px;
      color: #e2e8f0;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15, 118, 110, 0.15);
      color: #a5f3fc;
      font-size: 12px;
      margin-right: 8px;
    }
    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .btn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .status {
      font-size: 13px;
      color: var(--muted);
      margin-top: 10px;
      min-height: 18px;
    }
    .dual-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.62);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 50;
      backdrop-filter: blur(4px);
    }
    .overlay.hidden { display: none; }
    .overlay-card {
      width: min(760px, 92vw);
      background: #0f172a;
      color: #e2e8f0;
      border-radius: 18px;
      border: 1px solid #1e293b;
      padding: 22px 22px 18px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.45);
    }
    .overlay-title {
      font-size: 18px;
      margin: 0 0 6px;
      letter-spacing: -0.2px;
    }
    .overlay-sub {
      margin: 0 0 18px;
      color: #94a3b8;
      font-size: 13px;
    }
    .spinner {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 3px solid rgba(148, 163, 184, 0.25);
      border-top-color: var(--accent);
      animation: spin 0.9s linear infinite;
      margin: 10px 0 16px;
    }
    .step-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 10px;
    }
    .step-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(148, 163, 184, 0.08);
      border: 1px solid #1f2937;
      font-size: 14px;
    }
    .step-indicator {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid #475569;
      position: relative;
      flex-shrink: 0;
    }
    .step-item.active .step-indicator {
      border-color: var(--accent);
    }
    .step-item.active .step-indicator::after {
      content: "";
      position: absolute;
      inset: -5px;
      border-radius: 999px;
      border: 2px solid rgba(15, 118, 110, 0.35);
      animation: pulse 1.2s infinite;
    }
    .step-item.done .step-indicator {
      background: var(--accent);
      border-color: var(--accent);
    }
    .step-item.done .step-indicator::after {
      content: "";
      position: absolute;
      left: 3px;
      top: 1px;
      width: 4px;
      height: 7px;
      border: 2px solid #0f172a;
      border-top: 0;
      border-left: 0;
      transform: rotate(45deg);
    }
    .overlay-status {
      margin-top: 12px;
      font-size: 12px;
      color: #94a3b8;
      min-height: 16px;
    }
    @keyframes pulse {
      0% { opacity: 0.2; transform: scale(0.9); }
      70% { opacity: 0.6; transform: scale(1); }
      100% { opacity: 0.1; transform: scale(1.1); }
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <div class="tag">Resume-grounded LinkedIn DM</div>
        <h1>Craft a hiring manager message</h1>
        <p>Drop a resume, paste a JD and any LinkedIn note you received. The agent grounds highlights from your resume to justify fit and produces a ready-to-send reply.</p>
      </div>
    </header>

    <div class="grid">
      <div class="panel">
        <h2>Inputs</h2>
        <div class="section inline">
          <div>
            <label for="name">Your name (optional)</label>
            <input id="name" type="text" placeholder="Alex Rivera">
          </div>
          <div>
            <label for="role">Role (optional)</label>
            <input id="role" type="text" placeholder="Product Manager">
          </div>
        </div>
        <div class="section inline">
          <div>
            <label for="company">Company (optional)</label>
            <input id="company" type="text" placeholder="Northwind Labs">
          </div>
          <div>
            <label for="hm-name">Hiring manager name (optional)</label>
            <input id="hm-name" type="text" placeholder="Jordan Lee">
          </div>
        </div>

        <div class="section">
          <label for="jd">Job description *</label>
          <textarea id="jd" placeholder="Paste the JD or the recruiterâ€™s description..."></textarea>
        </div>

        <div class="section">
          <label for="hm-note">LinkedIn message from hiring manager</label>
          <textarea id="hm-note" placeholder="Hi Alex, we're opening a senior PM role focused on experimentation..."></textarea>
          <div class="hint">Optional, but it helps personalize the opener and matching.</div>
        </div>

        <div class="section">
          <label>Resume *</label>
          <div class="upload">
            <input id="resume-file" type="file" accept=".txt,.md,.rtf,.docx,.pdf">
            <div class="hint">Best results with a .txt export. You can also paste it below.</div>
          </div>
        </div>

        <div class="section">
          <label for="resume-text">Or paste resume text</label>
          <textarea id="resume-text" placeholder="Work experience, projects, education..."></textarea>
        </div>

        <div class="actions">
          <button class="btn" id="generate">Generate drafts</button>
          <div class="status" id="status"></div>
        </div>
      </div>

      <div class="panel">
        <h2>Drafts</h2>
        <div class="dual-grid">
          <div class="output">
            <header>
              <h3>LinkedIn message</h3>
              <div class="pill">Resume grounded</div>
            </header>
            <div id="message-output">Your message will appear here.</div>
          </div>
          <div class="actions" style="margin-top:8px;">
            <button class="btn secondary" id="copy-message">Copy</button>
            <button class="btn" id="download-message" style="background: var(--accent-2); color: #0f172a;">Download .txt</button>
            <div class="status" id="message-status"></div>
          </div>
          <div class="output">
            <header>
              <h3>Cover letter</h3>
              <div class="pill">Resume grounded</div>
            </header>
            <div id="cover-output">Your cover letter will appear here.</div>
          </div>
          <div class="actions" style="margin-top:8px;">
            <button class="btn secondary" id="copy-cover">Copy</button>
            <button class="btn" id="download-cover" style="background: var(--accent-2); color: #0f172a;">Download .txt</button>
            <div class="status" id="cover-status"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay hidden" id="overlay">
    <div class="overlay-card">
      <h3 class="overlay-title">Agent run in progress</h3>
      <p class="overlay-sub">Following the steps as the agent drafts each output.</p>
      <div class="spinner" aria-hidden="true"></div>
      <ul class="step-list">
        <li class="step-item" data-step="validate">
          <span class="step-indicator"></span>
          <span>Validate inputs</span>
        </li>
        <li class="step-item" data-step="prep">
          <span class="step-indicator"></span>
          <span>Prepare resume and job context</span>
        </li>
        <li class="step-item" data-step="message">
          <span class="step-indicator"></span>
          <span>Generate LinkedIn message</span>
        </li>
        <li class="step-item" data-step="cover">
          <span class="step-indicator"></span>
          <span>Generate cover letter</span>
        </li>
        <li class="step-item" data-step="finalize">
          <span class="step-indicator"></span>
          <span>Finalize outputs</span>
        </li>
      </ul>
      <div class="overlay-status" id="overlay-status"></div>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const messageEl = document.getElementById("message-output");
    const coverEl = document.getElementById("cover-output");
    const messageStatus = document.getElementById("message-status");
    const coverStatus = document.getElementById("cover-status");
    const overlayEl = document.getElementById("overlay");
    const overlayStatus = document.getElementById("overlay-status");
    const generateBtn = document.getElementById("generate");
    const stepItems = Array.from(document.querySelectorAll(".step-item"));
    let uploadedResume = "";
    let overlayTimer = null;
    let overlayStartedAt = 0;
    const API_BASE = "http://localhost:8000"; // Update if your API runs elsewhere.

    const setStatus = (msg, isError = false) => {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? "#b91c1c" : "var(--muted)";
    };
    const setOutputStatus = (el, msg, isError = false) => {
      el.textContent = msg;
      el.style.color = isError ? "#b91c1c" : "var(--muted)";
    };
    const resetOverlay = () => {
      stepItems.forEach((item) => {
        item.classList.remove("active", "done");
      });
      overlayStatus.textContent = "";
      overlayStatus.dataset.base = "";
      const first = stepItems.find((item) => item.dataset.step === "validate");
      if (first) first.classList.add("active");
    };
    const setStepState = (stepId, state) => {
      const item = stepItems.find((el) => el.dataset.step === stepId);
      if (!item) return;
      item.classList.remove("active", "done");
      if (state === "active") item.classList.add("active");
      if (state === "done") item.classList.add("done");
    };
    const showOverlay = () => {
      resetOverlay();
      overlayEl.classList.remove("hidden");
      generateBtn.disabled = true;
      overlayStartedAt = Date.now();
      if (overlayTimer) clearInterval(overlayTimer);
      overlayTimer = setInterval(() => {
        const elapsed = Math.max(0, Math.floor((Date.now() - overlayStartedAt) / 1000));
        const base = overlayStatus.dataset.base || "Working...";
        overlayStatus.textContent = `${base} (${elapsed}s)`;
      }, 1000);
    };
    const hideOverlay = () => {
      overlayEl.classList.add("hidden");
      generateBtn.disabled = false;
      if (overlayTimer) {
        clearInterval(overlayTimer);
        overlayTimer = null;
      }
    };
    const setOverlayStatus = (msg) => {
      overlayStatus.textContent = msg || "";
      overlayStatus.dataset.base = msg || "";
    };

    document.getElementById("resume-file").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) { uploadedResume = ""; return; }
      const reader = new FileReader();
      reader.onload = () => {
        uploadedResume = reader.result;
        setStatus(`Loaded resume: ${file.name}`);
      };
      reader.onerror = () => setStatus("Could not read that file. Try a .txt export.", true);
      reader.readAsText(file);
    });

    document.getElementById("generate").addEventListener("click", () => {
      setStatus("");
      showOverlay();
      const candidate = document.getElementById("name").value.trim();
      const role = document.getElementById("role").value.trim() || "Product Manager";
      const company = document.getElementById("company").value.trim();
      const hiringManager = document.getElementById("hm-name").value.trim();
      const jd = document.getElementById("jd").value.trim();
      const hmNote = document.getElementById("hm-note").value.trim();
      const resumeFallback = document.getElementById("resume-text").value.trim();
      const resumeText = uploadedResume.trim() || resumeFallback;

      if (!jd) {
        setStepState("validate", "done");
        hideOverlay();
        return setStatus("Please paste the job description.", true);
      }
      if (!resumeText) {
        setStepState("validate", "done");
        hideOverlay();
        return setStatus("Load or paste your resume.", true);
      }

      setStepState("validate", "done");
      setStepState("prep", "active");

      const payload = {
        name: candidate || null,
        resumeText,
        jdText: jd,
        hmNote: hmNote || null,
        role: role || null,
        company: company || null,
        hiringManager: hiringManager || null,
        topK: 2,
        embeddingModel: "text-embedding-3-small",
        chatModel: "gpt-4o-mini",
        orchestrate: true,
      };

      setStatus("Calling OpenAI backend...");
      setOverlayStatus("Running orchestration loop...");
      setStepState("prep", "done");
      setStepState("message", "active");
      setStepState("cover", "active");
      const callBackend = (outputType, controller) =>
        fetch(`${API_BASE}/generate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...payload, outputType }),
          signal: controller.signal,
        }).then(async (res) => {
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || "Backend error");
          }
          return res.json();
        });

      const messageController = new AbortController();
      const coverController = new AbortController();
      const timeout = setTimeout(() => {
        messageController.abort();
        coverController.abort();
      }, 120000);

      Promise.all([
        callBackend("message", messageController).then((msgData) => {
          setStepState("message", "done");
          return msgData;
        }),
        callBackend("cover-letter", coverController).then((coverData) => {
          setStepState("cover", "done");
          return coverData;
        }),
      ])
        .then(([msgData, coverData]) => {
          clearTimeout(timeout);
          messageEl.textContent = msgData.message || "No message returned.";
          coverEl.textContent = coverData.message || "No cover letter returned.";
          const msgTokens = msgData.tokenEstimate ? `msg ~${msgData.tokenEstimate} tok` : "";
          const coverTokens = coverData.tokenEstimate ? `cover ~${coverData.tokenEstimate} tok` : "";
          const tokenNote = [msgTokens, coverTokens].filter(Boolean).join(", ");
          setStatus(`Drafts updated (OpenAI). ${tokenNote}`);
          setOutputStatus(messageStatus, "");
          setOutputStatus(coverStatus, "");
          setStepState("finalize", "active");
          setOverlayStatus("Finalizing outputs...");
          setTimeout(() => {
            setStepState("finalize", "done");
            hideOverlay();
          }, 600);
        })
        .catch((err) => {
          console.error(err);
          clearTimeout(timeout);
          setStatus(err.message || "Failed to reach backend.", true);
          setOverlayStatus("Error from backend.");
          setTimeout(() => hideOverlay(), 800);
        });
    });

    const copyText = async (text, statusTarget) => {
      if (!text) {
        setOutputStatus(statusTarget, "Nothing to copy yet.", true);
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        setOutputStatus(statusTarget, "Copied.");
      } catch (err) {
        setOutputStatus(statusTarget, "Clipboard not available here.", true);
      }
    };

    const downloadText = (text, filename, statusTarget) => {
      if (!text) {
        setOutputStatus(statusTarget, "Nothing to download yet.", true);
        return;
      }
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      setOutputStatus(statusTarget, `Downloaded ${filename}`);
    };

    document.getElementById("copy-message").addEventListener("click", () => {
      const text = messageEl.textContent.trim();
      copyText(text && text !== "Your message will appear here." ? text : "", messageStatus);
    });

    document.getElementById("copy-cover").addEventListener("click", () => {
      const text = coverEl.textContent.trim();
      copyText(text && text !== "Your cover letter will appear here." ? text : "", coverStatus);
    });

    document.getElementById("download-message").addEventListener("click", () => {
      const text = messageEl.textContent.trim();
      downloadText(text && text !== "Your message will appear here." ? text : "", "message.txt", messageStatus);
    });

    document.getElementById("download-cover").addEventListener("click", () => {
      const text = coverEl.textContent.trim();
      downloadText(text && text !== "Your cover letter will appear here." ? text : "", "cover-letter.txt", coverStatus);
    });
  </script>
</body>
</html>
